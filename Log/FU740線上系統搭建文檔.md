# FU740線上系統搭建文檔

### 樹莓派

#### 0. 安裝系統

從[官網](https://www.raspberrypi.org/)下載相關軟件，點擊Computers->Software。	

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307110441584.png" alt="image-20220307110441584" style="zoom: 33%;" />

進入頁面後，在「Install Raspberry Pi OS using Raspberry Pi Imager」標題下方，可以看到不同系統的下載連結(此處以Windows為例)，根據自己的系統點擊下載Imager的安裝檔案。下載完成後安裝即可。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307110734492.png" alt="image-20220307110734492" style="zoom:33%;" />

將SD卡利用讀卡器連接到你的裝置上，並打開Raspberry Pi Imager。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111054624.png" alt="image-20220307111054624" style="zoom: 67%;" />

先進行格式化。先點擊選擇操作系統，選擇擦除。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111134506.png" alt="image-20220307111134506" style="zoom:50%;" />

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111230129.png" alt="image-20220307111230129" style="zoom: 150%;" />

然後選擇相應的SD卡

![image-20220307111304955](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111304955.png)

點擊燒錄。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111332730.png" alt="image-20220307111332730" style="zoom:67%;" />

點選"是"。



<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111510682.png" alt="image-20220307111510682" style="zoom:67%;" />

等待擦除，擦除完畢後點擊繼續。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111546906.png" alt="image-20220307111546906" style="zoom:67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111558570.png" alt="image-20220307111558570" style="zoom:67%;" />

此時可以安裝操作系統，重新選擇適合的操作系統，此處以安裝Ubuntu 20.04版本為例。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318110625604.png" alt="image-20220318110625604" style="zoom: 67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318110702110.png" alt="image-20220318110702110" style="zoom:67%;" />

或者可以在[Install Ubuntu on a Raspberry Pi | Ubuntu](https://ubuntu.com/download/raspberry-pi) 下載合適的鏡像，下載完成後直接點擊利用Raspberry Pi Imager打開即可。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318135442873.png" alt="image-20220318135442873" style="zoom:67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318141237880.png" alt="image-20220318141237880" style="zoom:67%;" />

按照剛才的操作，重新選擇SD卡，並進行燒錄。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307113441090.png" alt="image-20220307113441090" style="zoom:67%;" />

點擊燒錄，等待燒錄。安裝完成後把SD卡插到樹莓派上。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307113515341.png" alt="image-20220307113515341" style="zoom:67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318142614259.png" alt="image-20220318142614259" style="zoom:67%;" />

#### 1. 啟動樹莓派

對於開機設定，可以有兩種選擇

1. 如果有顯示器，直接接上，再接上電源線，鍵盤，鼠標等設備開機進行設置。

2. 如果沒有顯示器，便需要使用ssh來連接，對於Ubuntu第一次ssh登陸，需要有特定的操作

   1. 首先可以利用網線或者連接WIFI來讓樹莓派連上網絡，這裏是使用Windows台式機來作為初始連接，打開行動熱點頁面。

      ![image-20220318144824343](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318144824343.png)

   2. 在SD卡的`/system-boot`分區裏打開網絡配置文件`network-config`(注意只有在初始boot時才可以使用此方法)

      ```
      # This file contains a netplan-compatible configuration which cloud-init will
      # apply on first-boot (note: it will *not* update the config after the first
      # boot). Please refer to the cloud-init documentation and the netplan reference
      # for full details:
      #
      # https://cloudinit.readthedocs.io/en/latest/topics/network-config.html
      # https://cloudinit.readthedocs.io/en/latest/topics/network-config-format-v2.html
      # https://netplan.io/reference
      #
      # Please note that the YAML format employed by this file is sensitive to
      # differences in whitespace; if you are editing this file in an editor (like
      # Notepad) which uses literal tabs, take care to only use spaces for
      # indentation. See the following link for more details:
      #
      # https://en.wikipedia.org/wiki/YAML
      #
      # Some additional examples are commented out below
      
         version: 2
         ethernets:
           eth0:
             dhcp4: true
             optional: true
         #wifis:
         #  wlan0:
         #    dhcp4: true
         #    optional: true
         #    access-points:
         #      myhomewifi:
         #        password: "S3kr1t"
         #      myworkwifi:
         #        password: "correct battery horse staple"
         #      workssid:
         #        auth:
         #          key-management: eap
         #          method: peap
         #          identity: "me@example.com"
         #          password: "passw0rd"
         #          ca-certificate: /etc/my_ca.pem
      ```
      在最下方加入WiFi訊息，其中"wifi_name"為行動熱點的網絡名稱，"wifi_pwd"為行動熱點的網絡密碼。
      
      ```
       wifis:
           wlan0:
             dhcp4: true
             dhcp6: true
             optional: true
             access-points:
               "wifi_name":
                 password: "wifi_pwd"
      ```
      
   2. 配置用戶名。ubuntu 留有一组默认的用户名, 要求用户第一次登陆的时候改掉它. 但是第一次接通电源的时候是无法连接到 WiFi 的, 需要断电再上电. 此时通过 SSH 登陆会遇到问题 `passwd: Authentication token manipulation error`打开文件 `user-data`, 找到

      ```
      chpasswd:
        expire: true
        list:
        - ubuntu:ubuntu
      ```

      把 `expire: true` 改为 `expire: false` 这样系统可以用这组默认用户名密码 `ubuntu:ubuntu` 登陆系统, 直到修改密码.

   3. 保存文件，弹出SD卡

   4. 把SD卡插入树莓派

   5. 接上电源

   7. 通过主机的热点界面观察树莓派是否接入

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318145719233.png" alt="image-20220318145719233" style="zoom:67%;" />

   8. 然後可以通過ssh連接到樹莓派上，預設密碼為ubuntu

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322102855700.png" alt="image-20220322102855700" style="zoom: 80%;" />

   9. 可以利用公鑰免密SSH登入
   
      1. 在命行中輸入`ssh-keygen`，一直按`enter`即可。
      2. 利用`ssh-copy-id -i ~/.ssh/id_rsa.pub ubuntu@pi_ip`，上傳金鑰到樹莓派上。
      3. 然後在下次登陸時便不需要輸入密碼了。

#### 2. 連接Tsinghua-Secure

下一步把WiFi設置為Tsinghua-Secure。為了能夠得知設備更換WiFi後的IP地址，撰寫一個簡單的開機發IP地址到郵件的腳本，參考[網址]([使用 Python 将树莓派的 IP 发到邮箱 | 树莓派实验室 (nxez.com)](https://shumeipai.nxez.com/2020/01/02/send-email-raspberry-pi-ip-with-python.html))。先安裝python `sudo apt install python`、`sudo apt install net-tools`。(或者可以直接登上[這裏]([清华大学校园网自助服务系统 (tsinghua.edu.cn)](http://usereg.tsinghua.edu.cn/main.php))查看)

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220327182031867.png" alt="image-20220327182031867" style="zoom:67%;" />

   1. 以163mail為例，163 mail需要在設置裏，開啟smtp服務功能，然後記住所得到的授權密碼。

      ![image-20220322104608774](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322104608774.png)

      ![image-20220322111707029](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322111707029.png)

      ![image-20220322111748552](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322111748552.png)

      mail.py
      ```
      #!/usr/bin/python 
      #-*- coding:utf-8 -*-
      import smtplib 
      from email.mime.text import MIMEText 
      import sys  
      mail_host = 'smtp.163.com' #smtp地址
      mail_user = 'username' #你的郵箱帳號
      mail_pass = 'smtp_code' #smtp服務中提供的授權密碼
      mail_postfix = '163.com'
        
        
      def send_mail(to_list,subject,content): 
          me = 'myPi'+"<"+mail_user+"@"+mail_postfix+">"
          msg = MIMEText(content) 
          msg['Subject'] = subject 
          msg['From'] = me 
          msg['to'] = to_list 
            
          try: 
              s = smtplib.SMTP_SSL() 
              s.connect(mail_host) 
              s.login(mail_user,mail_pass) 
              s.sendmail(me,to_list,msg.as_string()) 
              s.close() 
              return True
          except Exception,e: 
              print str(e) 
              return False
            
      if __name__ == "__main__": 
              send_mail(sys.argv[1], sys.argv[2], sys.argv[3]) 
      ```

      ip.sh

      ```
      #!/bin/bash
      sleep 20
      wlan0=`ifconfig  wlan0 | head -n2 | grep inet | awk '{print$2}'`
      eth0=`ifconfig  eth0 | head -n2 | grep inet | awk '{print$2}'`
       
      if ping -c 2 -W 3 www.baidu.com &> /dev/null ;then
      /home/ubuntu/mail.py striketong@163.com "Got raspberryPi IP!" "WLAN0:$wlan0||ETH0:$eth0"
      fi
      ```

   2. 給予兩個腳本權限

      ```
      sudo chmod +x ip.sh
      sudo chmod +x mail.py
      ```

   3. 將腳本加入開機執行文件。這邊由於沒有rc.local，需要自己創建，參考[網址]([ubuntu没有/etc/rc.local解决办法，设置开机自启动_黄宝黄宝的技术博客_51CTO博客](https://blog.51cto.com/u_4048786/3204026))

      1. 創建systemd的服务脚本，`sudo vim /etc/systemd/system/rc-local.service`

         ```
         [Unit]
          Description=/etc/rc.local Compatibility
          ConditionPathExists=/etc/rc.local
         
         [Service]
          Type=forking
          ExecStart=/etc/rc.local start
          TimeoutSec=0
          StandardOutput=tty
          RemainAfterExit=yes
          SysVStartPriority=99
         
         [Install]
          WantedBy=multi-user.target
         ```

      2. 啟動服務

         ```
         sudo systemctl enable rc-local.service
         ```
      
      3. 編寫rc.local，`sudo vim /etc/rc.local`
      
         ```
         #!/bin/bash
         
         sudo /home/ubuntu/ip.sh
         ```

      4. 給予權限 `sudo chmod +x /etc/rc.local`

      5. 嘗試重啟設備 `sudo reboot`，看能否收到郵件

      6. 成功收到帶有IP的郵件

         ![image-20220322112758382](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322112758382.png)

      7. 根據學長們的[使用手冊]([服务 - THU Services](https://thu.services/services/#tsinghua-secure))，通過`wpa_supplicant`進行Tsinghua-Secure的配置

      8. 通過顯示屏，直接在樹莓派的Terminal 中，通过命令“iw dev”查看无线网卡的标识：

         ![image-20220322120137518](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322120137518.png)

      9. 输入如下命令，创建用于连接 802.1x 无线网络的配置文件：

         编辑 `vim /etc/wpa_supplicant/wpa_supplicant-nl80211-wlan0.conf`， 其中 `wlan0` 是本机网卡名称，输入以下配置
      
         ```
         ctrl_interface=/var/run/wpa_supplicant
         update_config=1
         
         network={
                 ssid="Tsinghua-Secure"
                 proto=RSN
                 key_mgmt=WPA-EAP
                 pairwise=CCMP
                 eap=PEAP
                 identity="username"
                 password="password"
                 phase2="auth=MSCHAPV2"
                 priority=9
         }  
         ```

         其中 `username` 与 `password` 为自己帐号相应信息。

      10. 重新編輯`ip.sh`
      
          ```
          #!/bin/bash
          sudo killall wpa_supplicant
          sleep 5
          sudo wpa_supplicant -B -c /etc/wpa_supplicant/wpa_supplicant-nl80211-wlan0.conf -i wlan0
          sudo dhclient wlan0
          sleep 30
          wlan0=`ifconfig  wlan0 | head -n2 | grep inet | awk '{print$2}'`
          eth0=`ifconfig  eth0 | head -n2 | grep inet | awk '{print$2}'`
           
          if ping -c 2 -W 3 www.baidu.com &> /dev/null ;then
          /home/ubuntu/mail.py striketong@163.com "Got raspberryPi IP!" "WLAN0:$wlan0||ETH0:$eth0"
          fi
          ```

      11. 重啟測試`sudo reboot`，看是否能自動連上Tsinghua-Secure
      
      12. 開機自動連接成功。

#### 3. 修改SSH port

由於校園網禁止22端口，所以需要修改預設端口。改成你想要的端口。需注意，0-1024，8000-8100，3389，9100這些都不能用。

1. `sudo vim /etc/ssh/ssh_config`、`sudo vim /etc/ssh/sshd_config`，找到`#Port 22`，改成`Port 8122`。

2. 設置防火牆

   ```
   sudo ufw allow 8122
   ```

3. 重啟SSH服務

   ```
   sudo service sshd restart
   ```

4. 嘗試利用SSH連接`ssh -p 8122 ubuntu@ip`，成功。

#### 4. 配置picocom

利用picocom來獲取串口的調試訊息，甚至可在串口直接為FU740安裝系統。

1. 安裝picocom

   ```
   sudo apt-get install picocom
   ```

#### 5. 配置usbip

FU740裏有內建的UART/JTAG to USB可以直接利用usb訪問串口。而對於遠程訪問，可以利用usbip遠程訪問USB，繼而訪問串口。

1. 安裝usbip

   ```
   sudo apt install linux-tools-common
   sudo apt install linux-tools-5.4.0-1058-raspi
   ```

2. 配置

   ```
   # server
   # load usbip kernel module
   sudo modprobe usbip_host
   # start control daemon
   sudo usbipd
   # list available local devices
   usbip list -l
   # export USB device
   sudo usbip bind -b <busid>
   #sudo usbip bind -b 1-1.1
   #sudo usbip bind -b 1-1.3
   ```

3. 編寫`sudo vim /etc/systemd/system/usbip.service`

   ```
   [Unit]
   Description=usbip host daemon
   After=network.target
   
   [Service]
   Type=forking
   ExecStart=/usr/sbin/usbipd -D
   ExecStartPost=/usr/sbin/usbip bind -b 1-1.1
   ExecStartPost=/usr/sbin/usbip bind -b 1-1.2
   ExecStartPost=/usr/sbin/usbip bind -b 1-1.3
   ExecStartPost=/usr/sbin/usbip unbind -b 1-1.1
   ExecStartPost=/usr/sbin/usbip unbind -b 1-1.2
   ExecStartPost=/usr/sbin/usbip unbind -b 1-1.3
   
   [Install]
   WantedBy=multi-user.target
   ```
   
4. 啟用服務

   ```
   sudo systemctl enable u.service
   ```

5. 用戶端配置

   ```
   # client
   # load vhci-hcd kernel module
   modprobe vhci-hcd
   # list available remote devices
   usbip list -r <server>
   # attach remote device locally
   usbip attach -r <server> -b <busid>
   
#### 6. 配置tftp

需要利用tftp來為FU740安裝系統。

1. 安裝tftp，`sudo apt install tftpd-hpa`

2. 更改配置文件，`sudo vim /etc/default/tftpd-hpa`，添加`--create`

   ```
   # /etc/default/tftpd-hpa
   
   TFTP_USERNAME="tftp"
   TFTP_DIRECTORY="/srv/tftp"
   TFTP_ADDRESS=":69"
   TFTP_OPTIONS="--secure --create"
   ```

3. 更改工作文件夾權限

   ```
   sudo chown tftp:tftp /srv/tftp
   ```

4. 啟動服務

   ```
   sudo systemctl restart tftpd-hpa
   ```

5. 查看服務是否正在運行

   ```
   sudo systemctl status tftpd-hpa
   
   ● tftpd-hpa.service - LSB: HPA's tftp server
        Loaded: loaded (/etc/init.d/tftpd-hpa; generated)
        Active: active (running) since Fri 2022-04-01 06:24:58 UTC; 6min ago
          Docs: man:systemd-sysv-generator(8)
       Process: 841 ExecStart=/etc/init.d/tftpd-hpa start (code=exited, status=0/SUCCESS)
         Tasks: 1 (limit: 9257)
        CGroup: /system.slice/tftpd-hpa.service
                └─864 /usr/sbin/in.tftpd --listen --user tftp --address :69 --secure --create /srv/tftp
   
   Apr 01 06:24:57 ubuntu systemd[1]: Starting LSB: HPA's tftp server...
   Apr 01 06:24:58 ubuntu tftpd-hpa[841]:  * Starting HPA's tftpd in.tftpd
   Apr 01 06:24:58 ubuntu tftpd-hpa[841]:    ...done.
   Apr 01 06:24:58 ubuntu systemd[1]: Started LSB: HPA's tftp server.
   ```

#### 7. 配置dhcp

1. 安裝dhcp

   ```
   sudo apt-get install isc-dhcp-server
   ```
   
3. 啟用服務

   ```
   sudo systemctl start isc-dhcp-server
   sudo systemctl enable isc-dhcp-server
   ```

4. 配置DHCP服務器文件，`sudo vim /etc/dhcp/dhcpd.conf`，添加如下內容

   ```
   subnet 10.0.1.0 netmask 255.255.255.0 {
      authoritative;
      range 10.0.1.5 10.0.1.255;
      default-lease-time 3600;
      max-lease-time 3600;
      option subnet-mask 255.255.255.0;
      option broadcast-address 10.0.1.255;
      option routers 10.0.1.5;
      option domain-name-servers 166.111.8.28; # 清華的DNS
      host rpiroot { #為主機分配固定的IP
           hardware ethernet e4:5f:01:56:d8:57;
           fixed-address 10.0.1.5;
      }
      host ubuntu { #在首次登入後，可根據板子的網卡MAC地址來分配固定IP
      		hardware ethernet XX:XX:XX:XX:XX:XX;
           fixed-address 10.0.1.10;
      }
   }
   ```
   
5. 設定DHCP啟用的網絡卡，`sudo vim /etc/default/isc-dhcp-server`，`sudo vim /etc/default/dhcpd.conf`

   ```
   INTERFACESv4="eth0"
   ```

6. 重啟DHCP服務

   ```
   sudo systemctl restart isc-dhcp-server
   ```

7. 查看DHCP服務是否運行

   ```
   sudo systemctl status isc-dhcp-server
   
   lines 1--1...skipping...
   ● isc-dhcp-server.service - ISC DHCP IPv4 server
        Loaded: loaded (/lib/systemd/system/isc-dhcp-server.service; enabled; vendor preset:>
        Active: active (running) since Thu 2022-03-31 12:40:41 UTC; 12s ago
          Docs: man:dhcpd(8)
      Main PID: 91898 (dhcpd)
         Tasks: 4 (limit: 9257)
        CGroup: /system.slice/isc-dhcp-server.service
                └─91898 dhcpd -user dhcpd -group dhcpd -f -4 -pf /run/dhcp-server/dhcpd.pid >
   
   Mar 31 12:40:41 ubuntu dhcpd[91898]: PID file: /run/dhcp-server/dhcpd.pid
   Mar 31 12:40:41 ubuntu sh[91898]: Wrote 0 leases to leases file.
   Mar 31 12:40:41 ubuntu dhcpd[91898]: Wrote 0 leases to leases file.
   Mar 31 12:40:41 ubuntu dhcpd[91898]: Listening on LPF/eth0/e4:5f:01:56:d8:57/10.0.1.0/24
   Mar 31 12:40:41 ubuntu sh[91898]: Listening on LPF/eth0/e4:5f:01:56:d8:57/10.0.1.0/24
   Mar 31 12:40:41 ubuntu sh[91898]: Sending on   LPF/eth0/e4:5f:01:56:d8:57/10.0.1.0/24
   Mar 31 12:40:41 ubuntu sh[91898]: Sending on   Socket/fallback/fallback-net
   Mar 31 12:40:41 ubuntu dhcpd[91898]: Sending on   LPF/eth0/e4:5f:01:56:d8:57/10.0.1.0/24
   Mar 31 12:40:41 ubuntu dhcpd[91898]: Sending on   Socket/fallback/fallback-net
   Mar 31 12:40:41 ubuntu dhcpd[91898]: Server starting service.
   ~
   ~
   ```

8. 為樹莓派配置固定IP，修改DHCP服務器文件`sudo vim /etc/dhcp/dhcpd.conf`，添加host，此後在每次分配時樹莓派上的有線網絡便會得到固定的IP地址。

   ```
   subnet 10.0.1.0 netmask 255.255.255.0 {
      authoritative;
      range 10.0.1.5 10.0.1.255;
      default-lease-time 3600;
      max-lease-time 3600;
      option subnet-mask 255.255.255.0;
      option broadcast-address 10.0.1.255;
      option routers 10.0.1.5;
      host rpiroot {
           hardware ethernet e4:5f:01:56:d8:57;
           fixed-address 10.0.1.5;
      }  
   }
   ```


#### 8. 建立遠程響應網站

為了避免每次登入樹莓派才能啟動FU740，在此利用http請求實現一個更簡單的開機關機的方法。

1. 安裝Flask，`sudo apt-get install -y python3-flask`

2. 編輯`power.py`，利用Flask建立簡易網站用以接收開關機操作請求。

   ```
   from flask import Flask
   import RPi.GPIO as GPIO
   import gpiod
   import time
   
   def button(secs, line):
       with gpiod.Chip("gpiochip0") as chip:
           line = chip.get_line(line)
           line.request(consumer="powerd", type=gpiod.LINE_REQ_DIR_OUT)
           line.set_value(1)
           time.sleep(secs)
           line.set_value(0)
   
   app = Flask(__name__)
   
   @app.route("/")
   def hello_world():
       return "<p>Hello, World!</p>"
   
   @app.route("/poweron1")
   def poweron1():
       button(1, 14)
       return "<p>Power on machine-1!</p>"
   
   @app.route("/poweroff1")
   def poweroff1():
       button(4, 14)
       return "<p>Power off machine-1!</p>"""
   
   @app.route("/reboot1")
   def reboot1():
       button(4, 14)
       time.sleep(1)
       button(1, 14)
       return "Rebooted machine-1!"
   
   @app.route("/poweron2")
   def poweron2():
       button(1, 15)
       return "<p>Power on machine-2!</p>"
   
   @app.route("/poweroff2")
   def poweroff2():
       button(4, 15)
       return "<p>Power off machine-2!</p>"""
   
   @app.route("/reboot2")
   def reboot2():
       button(4, 15)
       time.sleep(1)
       button(1, 15)
       return "Rebooted machine-2!"
   
   if __name__ == '__main__':
       button(0, 14)
       button(0, 15)
       app.run(host='0.0.0.0', port=8182)
   
   ```

3. 運行程序`python3 power.py`，之後便可以通過`http://IP:8182/operation`進行開關機操作。

4. 配置服務文件，使得在樹莓派開機時自動運行`power.py`

   1. 編寫服務文件`sudo vim /etc/systemd/system/power.service`

   ```
   [Unit]
   Description=power control daemon
   After=network.target
   
   [Service]
   ExecStart=/usr/bin/python3 /home/ubuntu/test/power.py
   
   [Install]
   WantedBy=multi-user.target
   ```

   2. 啟動服務

   ```
   sudo systemctl enable power.service
   ```

#### 9. 配置NAT

為了讓板子能連接外網，需要配置一下NAT。

1. 配置NAT

	```
sudo iptables -t nat -F POSTROUTING
sudo iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o wlan0 -s 10.0.1.0/24 -m conntrack --ctstate NEW -j ACCEPT
sudo iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
	```

2. 保存iptables，確保每次開機後都能加載NAT規則

   ```
   sudo iptables-save | sudo tee /etc/iptables.sav
   ```

   編輯`sudo vim /etc/rc.local`，加入

   ```
   sudo iptables-restore < /etc/iptables.sav
   ```

3. 開啟路由轉發，編輯`sudo vim /etc/sysctl.conf` 文件

   ```
   #net.ipv4.ip_forward=1 --> net.ipv4.ip_forward=1
   ```

4. 啟用服務

   ```
   sudo sysctl -p
   ```

### FU740

#### 1. 連接樹莓派與FU740

1. 利用杜邦線物理連接樹莓派與FU740

   1. 把原本版子上的`POWER SW`線換成自己的杜邦線。

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328150633057.png" alt="image-20220328150633057" style="zoom: 25%;" />

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328150655239.png" alt="image-20220328150655239" style="zoom: 25%;" />

   2. 把繼電器全部切換成高電平觸發

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328151918376.png" alt="image-20220328151918376" style="zoom:25%;" />

   3. 將杜邦線連接到繼電器上。（切記不要弄反，紫色接到NO1，白色接到COM1）

   4. 將樹莓派上的5V，GND以及訊號線(GPIO)接到繼電哭上的DC+，DC-，IN1上。接好後應如下圖所示。

      可以利用`pinout`來查看樹莓派上的對應接口。這裏接GPIO14。

      ![image-20220328152209310](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328152209310.png)

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328151624825.png" alt="image-20220328151624825" style="zoom:20%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220403145027796.png" alt="image-20220403145027796" style="zoom: 20%;" />

   5. 接上FU740電源，進行下一步調試。

2. 在樹莓派上安裝python GPIO庫，`sudo apt-get install python3-dev python3-rpi.gpio`，撰寫GPIO測試程序`power.py`。

   給予python權限，`sudo chmod 4775 /usr/bin/python`，`sudo chmod 4775 /usr/bin/python3`

   - 1秒是開機，4秒是強制關機。
   
   ```
   import gpiod
   import time
   
   def button(secs, line):
       with gpiod.Chip("gpiochip0") as chip:
           line = chip.get_line(line)
           line.request(consumer="powerd", type=gpiod.LINE_REQ_DIR_OUT)
           line.set_value(1)
           time.sleep(secs)
           line.set_value(0)
           
   if __name__ == '__main__':
   	button(1, 14)
   ```
   
   運行語句`python3 power.py`，運行後應該可以聽到十分清脆的繼電器啟動聲音以及十分響亮的風扇聲。這便說明成功利用樹莓派控制板子啟動了。


#### 2. 安裝U-Boot 

1. 在SD卡上寫入[U-boot]([Release HiFive Unmatched SD Image & U-Boot SPI Installer · zhaofengli/nixos-riscv64 (github.com)](https://github.com/zhaofengli/nixos-riscv64/releases/tag/2022011700))

2. 利用[Etcher]([balenaEtcher - Flash OS images to SD cards & USB drives](https://www.balena.io/etcher/))把鏡像燒錄到SD卡上

   <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220330144132821.png" alt="image-20220330144132821" style="zoom:50%;" />

3. 連接樹莓派與FU740終端，然後查看是否已經接上

   ```
   lsusb
   ```

   如正確接入，應出下類似下面的訊息

   ```
   Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
   Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
   Bus 001 Device 004: ID 0403:6010 Future Technology Devices International, Ltd FT2232C/D/H Dual UART/FIFO IC
   Bus 001 Device 005: ID 0403:6010 Future Technology Devices International, Ltd FT2232C/D/H Dual UART/FIFO IC
   Bus 001 Device 002: ID 2109:3431 VIA Labs, Inc. Hub
   Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
   ```

   其中的 Device 004 和 Device 005 便是接上的數據線。

4. 查看設備會話接口號

   ```
   ls /dev/ttyUSB*
   $ /dev/ttyUSB0  /dev/ttyUSB1
   ```

   可以看到兩條數據線的名稱分別為 ttyUSB0 和 ttyUBS1。

5. 利用picocom連接到串口，然後進行串口調試

   ```
   sudo picocom -b 115200 /dev/ttyUSB0
   ```

   ```
   picocom v3.1
   
   port is        : /dev/ttyUSB0
   flowcontrol    : none
   baudrate is    : 115200
   parity is      : none
   databits are   : 8
   stopbits are   : 1
   escape is      : C-a
   local echo is  : no
   noinit is      : no
   noreset is     : no
   hangup is      : no
   nolock is      : no
   send_cmd is    : sz -vv
   receive_cmd is : rz -vv -E
   imap is        : 
   omap is        : 
   emap is        : crcrlf,delbs,
   logfile is     : none
   initstring     : none
   exit_after is  : not set
   exit is        : no
   
   Type [C-a] [C-h] to see available commands
   Terminal ready
   ```

   若正常，會出現Terminal ready提示語句。

6. 把SD卡插回FU740上，訪問網站指令開機。

7. 應該會在命令行上看到如下輸出

   ```
   ...
   Device 0: Vendor: 0x144d Rev: 2B2QEXM7 Prod: S4EUNX0R802232Z     
               Type: Hard Disk
               Capacity: 238475.1 MB = 232.8 GB (488397168 x 512)
   ... is now current device
   ** No partition table - nvme 0 **
   Couldn't find partition nvme 0:1
   starting USB...
   Bus xhci_pci: Register 4000840 NbrPorts 4
   Starting the controller
   USB XHCI 1.00
   scanning bus xhci_pci for devices... 3 USB Device(s) found
          scanning usb for storage devices... 0 Storage Device(s) found
   
   Device 0: unknown device
   switch to partitions #0, OK
   mmc0 is current device
   Scanning mmc 0:3...
   Found U-Boot script /boot.scr
   2236 bytes read in 4 ms (545.9 KiB/s)
   ## Executing script at 88100000
   
   Firmware installer
   
   
   Installing U-Boot to the SPI flash in 10 seconds!
   devtype = mmc
   devnum = 0
   bootpart = 3
   
   :: Starting flash operation
   
   -> Initializing SPI Flash subsystem...
   SF: Detected is25wp256 with page size 256 Bytes, erase size 4 KiB, total 32 MiB
   
   -> Reading new firmware from storage...
   6291456 bytes read in 5423 ms (1.1 MiB/s)
   
   -> Writing new firmware to SPI...
   device 0 offset 0x0, size 0x600000
   2691072 bytes written, 3600384 bytes skipped in 47.308s, speed 136770 B/s
   
   ✅ Flashing seems to have been successful!
   You can now set MSEL[3:0] = 0110
   
   Resetting in 5 seconds
   resetting ...	
   System reset not supported on this platform
   ### ERROR ### Please RESET the board ###
   ```

 8. 安裝完後把板子上的 MSEL碼 撥成(MSEL[3:0]=0110)，在下一次啟動時便不需要用到SD卡了

    ```
    --------------- ON
    |  | | o o |  |
    |  o o | | o  |
    --------------- OFF
    ```

 9. 重新啟動機器，應該會出現如下輸出

    ```
    U-Boot SPL 2022.01 (Jan 01 1980 - 00:00:00 +0000)
    Trying to boot from SPI
    
    
    U-Boot 2022.01 (Jan 01 1980 - 00:00:00 +0000)
    
    CPU:   rv64imafdc
    Model: SiFive HiFive Unmatched A00
    DRAM:  16 GiB
    MMC:   spi@10050000:mmc@0: 0
    Loading Environment from SPIFlash... SF: Detected is25wp256 with page size 256 Bytes, erase size 4 KiB, total 32 MiB
    *** Warning - bad CRC, using default environment
    
    EEPROM: SiFive PCB EEPROM format v1
    Product ID: 0002 (HiFive Unmatched)
    PCB revision: 3
    BOM revision: B
    BOM variant: 0
    Serial number: SF105SZ212200785
    Ethernet MAC address: 70:b3:d5:92:f9:e1
    CRC: a2ae439d
    In:    serial@10010000
    Out:   serial@10010000
    Err:   serial@10010000
    Model: SiFive HiFive Unmatched A00
    Net:   eth0: ethernet@10090000
    Hit any key to stop autoboot:  0 
    PCIE-0: Link up (Gen1-x8, Bus0)
    
    Device 0: Vendor: 0x144d Rev: 2B2QEXM7 Prod: S4EUNX0R802232Z     
                Type: Hard Disk
                Capacity: 238475.1 MB = 232.8 GB (488397168 x 512)
    ... is now current device
    ** No partition table - nvme 0 **
    Couldn't find partition nvme 0:1
    starting USB...
    Bus xhci_pci: Register 4000840 NbrPorts 4
    Starting the controller
    USB XHCI 1.00
    scanning bus xhci_pci for devices... 3 USB Device(s) found
           scanning usb for storage devices... 0 Storage Device(s) found
    
    Device 0: unknown device
    scanning bus for devices...
    
    Device 0: unknown device
    ethernet@10090000: PHY present at 0
    ethernet@10090000: Starting autonegotiation...
    ethernet@10090000: Autonegotiation timed out (status=0x7949)
    ethernet@10090000: link down (status: 0x7949)
    missing environment variable: pxeuuid
    ...
    =>
    ```

    當出現`=>`時，便可進行下一步操作。

#### 3. 安裝系統
 1. 先下載一個系統鏡像，可以下載一個preinstalled的，在這裏使用[*Unmatched preinstalled server* image Ubuntu server 20.04]([Ubuntu 20.04.4 LTS (Focal Fossa) (u-toyama.ac.jp)](http://ubuntutym2.u-toyama.ac.jp/ubuntu-dvd/20.04/release/))為例子。

     ![image-20220401143831931](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220401143831931.png)

     複製下載連結，然後在樹莓派上cd到/srv/tftp，下載鏡像到此文件夾。

     ```
     cd /srv/tftp
     
     sudo wget http://ubuntutym2.u-toyama.ac.jp/ubuntu-dvd/20.04/release/ubuntu-20.04.4-preinstalled-server-riscv64+unmatched.img.xz
     ```

 2. 下載後解壓，然後可以把文件改名，比如換成`ubuntu.img`

     ```
     sudo xz -d ubuntu-20.04.4-preinstalled-server-riscv64+unmatched.img.xz
     
     sudo mv ubuntu-20.04.4-preinstalled-server-riscv64+unmatched.img ubuntu.img
     ```

 3. 查看鏡像的大小

     ```
     stat ubuntu.img
     
     File: ubuntu.img
       Size: 3758096384      Blocks: 5719456    IO Block: 4096   regular file
     Device: b302h/45826d    Inode: 131263      Links: 1
     Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
     Access: 2022-04-01 09:14:52.854195481 +0000
     Modify: 2022-03-25 04:52:26.000000000 +0000
     Change: 2022-04-01 09:21:19.560816976 +0000
      Birth: -
     ```

     記下Blocks的大小。

 4. 打開需要安裝的機器，並利用picocom連接串口

     ```
     sudo picocom -b 115200 /dev/ttyUSB1
     ```

 5. 在啟動時會出現`Hit any key to stop autoboot:2`提示語句，按任意鍵停止autoboot後出現`=>`

 6. 輸入如下語句來安裝系統，其中<block cnt>為上面記錄的Block大小，serverip為樹莓派上eth0的IP

     ```
     dhcp
     setenv serverip 10.0.1.5
     tftp 0x100000000 ubuntu.img
     pci enum
     nvme scan
     nvme write 0x100000000 0 <block cnt>
     #nvme write 0x100000000 0 5719456
     ```
     
 7. 等待系統安裝

 8. 如安裝成功，重啟後應該會出現如下選項，輸入`1`

     ```
     Device 0: Vendor: 0x144d Rev: 2B2QEXM7 Prod: S4EUNC0N929441N     
                 Type: Hard Disk
                 Capacity: 238475.1 MB = 232.8 GB (488397168 x 512)
     ... is now current device
     Scanning nvme 0:1...
     Found /boot/extlinux/extlinux.conf
     Retrieving file: /boot/extlinux/extlinux.conf
     U-Boot menu
     1:      Ubuntu 20.04.4 LTS 5.11.0-1029-generic
     2:      Ubuntu 20.04.4 LTS 5.11.0-1029-generic (rescue target)
     Enter choice: 
     ```

 9. 到此便成功安裝系統，可以登入系統進行調試。

#### 4. HDMI輸出

#### 5. $\mu$Core

