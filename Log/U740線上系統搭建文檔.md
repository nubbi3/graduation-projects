# U740線上系統搭建文檔

### 樹莓派

#### 0. 安裝系統

從[官網](https://www.raspberrypi.org/)下載相關軟件，點擊Computers->Software。	

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307110441584.png" alt="image-20220307110441584" style="zoom: 33%;" />

進入頁面後，在「Install Raspberry Pi OS using Raspberry Pi Imager」標題下方，可以看到不同系統的下載連結(此處以Windows為例)，根據自己的系統點擊下載Imager的安裝檔案。下載完成後安裝即可。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307110734492.png" alt="image-20220307110734492" style="zoom:33%;" />

將SD卡利用讀卡器連接到你的裝置上，並打開Raspberry Pi Imager。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111054624.png" alt="image-20220307111054624" style="zoom: 67%;" />

先進行格式化。先點擊選擇操作系統，選擇擦除。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111134506.png" alt="image-20220307111134506" style="zoom:50%;" />

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111230129.png" alt="image-20220307111230129" style="zoom: 150%;" />

然後選擇相應的SD卡

![image-20220307111304955](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111304955.png)

點擊燒錄。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111332730.png" alt="image-20220307111332730" style="zoom:67%;" />

點選"是"。



<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111510682.png" alt="image-20220307111510682" style="zoom:67%;" />

等待擦除，擦除完畢後點擊繼續。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111546906.png" alt="image-20220307111546906" style="zoom:67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307111558570.png" alt="image-20220307111558570" style="zoom:67%;" />

此時可以安裝操作系統，重新選擇適合的操作系統，此處以安裝Ubuntu 20.04版本為例。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318110625604.png" alt="image-20220318110625604" style="zoom: 67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318110702110.png" alt="image-20220318110702110" style="zoom:67%;" />

或者可以在[Install Ubuntu on a Raspberry Pi | Ubuntu](https://ubuntu.com/download/raspberry-pi) 下載合適的鏡像，下載完成後直接點擊利用Raspberry Pi Imager打開即可。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318135442873.png" alt="image-20220318135442873" style="zoom:67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318141237880.png" alt="image-20220318141237880" style="zoom:67%;" />

按照剛才的操作，重新選擇SD卡，並進行燒錄。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307113441090.png" alt="image-20220307113441090" style="zoom:67%;" />

點擊燒錄，等待燒錄。安裝完成後把SD卡插到樹莓派上。

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220307113515341.png" alt="image-20220307113515341" style="zoom:67%;" /><img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318142614259.png" alt="image-20220318142614259" style="zoom:67%;" />

#### 1. 啟動樹莓派

對於開機設定，可以有兩種選擇

1. 如果有顯示器，直接接上，再接上電源線，鍵盤，鼠標等設備開機進行設置。

2. 如果沒有顯示器，便需要使用ssh來連接，對於Ubuntu第一次ssh登陸，需要有特定的操作

   1. 首先可以利用網線或者連接WIFI來讓樹莓派連上網絡，這裏是使用Windows台式機來作為初始連接，打開行動熱點頁面。

      ![image-20220318144824343](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318144824343.png)

   2. 在SD卡的`/system-boot`分區裏打開網絡配置文件`network-config`(注意只有在初始boot時才可以使用此方法)

      ```
      # This file contains a netplan-compatible configuration which cloud-init will
      # apply on first-boot (note: it will *not* update the config after the first
      # boot). Please refer to the cloud-init documentation and the netplan reference
      # for full details:
      #
      # https://cloudinit.readthedocs.io/en/latest/topics/network-config.html
      # https://cloudinit.readthedocs.io/en/latest/topics/network-config-format-v2.html
      # https://netplan.io/reference
      #
      # Please note that the YAML format employed by this file is sensitive to
      # differences in whitespace; if you are editing this file in an editor (like
      # Notepad) which uses literal tabs, take care to only use spaces for
      # indentation. See the following link for more details:
      #
      # https://en.wikipedia.org/wiki/YAML
      #
      # Some additional examples are commented out below
      
         version: 2
         ethernets:
           eth0:
             dhcp4: true
             optional: true
         #wifis:
         #  wlan0:
         #    dhcp4: true
         #    optional: true
         #    access-points:
         #      myhomewifi:
         #        password: "S3kr1t"
         #      myworkwifi:
         #        password: "correct battery horse staple"
         #      workssid:
         #        auth:
         #          key-management: eap
         #          method: peap
         #          identity: "me@example.com"
         #          password: "passw0rd"
         #          ca-certificate: /etc/my_ca.pem
      ```
      在最下方加入WiFi訊息，其中"wifi_name"為行動熱點的網絡名稱，"wifi_pwd"為行動熱點的網絡密碼。
      
      ```
       wifis:
           wlan0:
             dhcp4: true
             dhcp6: true
             optional: true
             access-points:
               "wifi_name":
                 password: "wifi_pwd"
      ```
      
   2. 配置用戶名。ubuntu 留有一组默认的用户名, 要求用户第一次登陆的时候改掉它. 但是第一次接通电源的时候是无法连接到 WiFi 的, 需要断电再上电. 此时通过 SSH 登陆会遇到问题 `passwd: Authentication token manipulation error`打开文件 `user-data`, 找到

      ```
      chpasswd:
        expire: true
        list:
        - ubuntu:ubuntu
      ```

      把 `expire: true` 改为 `expire: false` 这样系统可以用这组默认用户名密码 `ubuntu:ubuntu` 登陆系统, 直到修改密码.

   3. 保存文件，弹出SD卡

   4. 把SD卡插入树莓派

   5. 接上电源

   7. 通过主机的热点界面观察树莓派是否接入

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220318145719233.png" alt="image-20220318145719233" style="zoom:67%;" />

   8. 然後可以通過ssh連接到樹莓派上，預設密碼為ubuntu

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322102855700.png" alt="image-20220322102855700" style="zoom: 80%;" />

   9. 可以利用公鑰免密SSH登入
   
      1. 在命行中輸入`ssh-keygen`，一直按`enter`即可。
      2. 利用`ssh-copy-id -i ~/.ssh/id_rsa.pub ubuntu@pi_ip`，上傳金鑰到樹莓派上。
      3. 然後在下次登陸時便不需要輸入密碼了。

#### 2. 連接Tsinghua-Secure

下一步把WiFi設置為Tsinghua-Secure。為了能夠得知設備更換WiFi後的IP地址，撰寫一個簡單的開機發IP地址到郵件的腳本，參考[網址]([使用 Python 将树莓派的 IP 发到邮箱 | 树莓派实验室 (nxez.com)](https://shumeipai.nxez.com/2020/01/02/send-email-raspberry-pi-ip-with-python.html))。先安裝python `sudo apt install python`、`sudo apt install net-tools`。(或者可以直接登上[這裏]([清华大学校园网自助服务系统 (tsinghua.edu.cn)](http://usereg.tsinghua.edu.cn/main.php))查看)

<img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220327182031867.png" alt="image-20220327182031867" style="zoom:67%;" />

   1. 以163mail為例，163 mail需要在設置裏，開啟smtp服務功能，然後記住所得到的授權密碼。

      ![image-20220322104608774](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322104608774.png)

      ![image-20220322111707029](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322111707029.png)

      ![image-20220322111748552](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322111748552.png)

      mail.py
      ```
      #!/usr/bin/python 
      #-*- coding:utf-8 -*-
      import smtplib 
      from email.mime.text import MIMEText 
      import sys  
      mail_host = 'smtp.163.com' #smtp地址
      mail_user = 'username' #你的郵箱帳號
      mail_pass = 'smtp_code' #smtp服務中提供的授權密碼
      mail_postfix = '163.com'
        
        
      def send_mail(to_list,subject,content): 
          me = 'myPi'+"<"+mail_user+"@"+mail_postfix+">"
          msg = MIMEText(content) 
          msg['Subject'] = subject 
          msg['From'] = me 
          msg['to'] = to_list 
            
          try: 
              s = smtplib.SMTP_SSL() 
              s.connect(mail_host) 
              s.login(mail_user,mail_pass) 
              s.sendmail(me,to_list,msg.as_string()) 
              s.close() 
              return True
          except Exception,e: 
              print str(e) 
              return False
            
      if __name__ == "__main__": 
              send_mail(sys.argv[1], sys.argv[2], sys.argv[3]) 
      ```

      ip.sh

      ```
      #!/bin/bash
      sleep 20
      wlan0=`ifconfig  wlan0 | head -n2 | grep inet | awk '{print$2}'`
      eth0=`ifconfig  eth0 | head -n2 | grep inet | awk '{print$2}'`
       
      if ping -c 2 -W 3 www.baidu.com &> /dev/null ;then
      /home/ubuntu/mail.py striketong@163.com "Got raspberryPi IP!" "WLAN0:$wlan0||ETH0:$eth0"
      fi
      ```

   2. 給予兩個腳本權限

      ```
      sudo chmod +x ip.sh
      sudo chmod +x mail.py
      ```

   3. 將腳本加入開機執行文件。這邊由於沒有rc.local，需要自己創建，參考[網址]([ubuntu没有/etc/rc.local解决办法，设置开机自启动_黄宝黄宝的技术博客_51CTO博客](https://blog.51cto.com/u_4048786/3204026))

      1. 創建systemd的服务脚本，`sudo vim /etc/systemd/system/rc-local.service`

         ```
         [Unit]
          Description=/etc/rc.local Compatibility
          ConditionPathExists=/etc/rc.local
         
         [Service]
          Type=forking
          ExecStart=/etc/rc.local start
          TimeoutSec=0
          StandardOutput=tty
          RemainAfterExit=yes
          SysVStartPriority=99
         
         [Install]
          WantedBy=multi-user.target
         ```

      2. 啟動服務，`sudo systemctl enable rc-local.service`

      3. 編寫rc.local，`sudo vim /etc/rc.local`

         ```
         #!/bin/bash
         
         sudo /home/ubuntu/ip.sh
         ```

      4. 給予權限 `sudo chmod +x /etc/rc.local`

      5. 嘗試重啟設備 `sudo reboot`，看能否收到郵件

      6. 成功收到帶有IP的郵件

         ![image-20220322112758382](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322112758382.png)

      7. 根據學長們的[使用手冊]([服务 - THU Services](https://thu.services/services/#tsinghua-secure))，通過`wpa_supplicant`進行Tsinghua-Secure的配置

         安裝dhcpcd，`sudo apt install dhcpcd5`。

      8. 通過顯示屏，直接在樹莓派的Terminal 中，通过命令“iw dev”查看无线网卡的标识：

         ![image-20220322120137518](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220322120137518.png)

      9. 输入如下命令，创建用于连接 802.1x 无线网络的配置文件：

         编辑 `vim /etc/wpa_supplicant/wpa_supplicant-nl80211-wlan0.conf`， 其中 `wlan0` 是本机网卡名称，输入以下配置

         ```
         ctrl_interface=/var/run/wpa_supplicant
         update_config=1
         
         network={
                 ssid="Tsinghua-Secure"
                 proto=RSN
                 key_mgmt=WPA-EAP
                 pairwise=CCMP
                 eap=PEAP
                 identity="username"
                 password="password"
                 phase2="auth=MSCHAPV2"
                 priority=9
         }  
         ```

         其中 `username` 与 `password` 为自己帐号相应信息。

      10.  重新編輯`ip.sh`

          ```
          #!/bin/bash
          sudo killall wpa_supplicant
          sleep 5
          sudo wpa_supplicant -B -c /etc/wpa_supplicant/wpa_supplicant-nl80211-wlan0.conf -i wlan0
          sudo dhclient wlan0
          sleep 30
          wlan0=`ifconfig  wlan0 | head -n2 | grep inet | awk '{print$2}'`
          eth0=`ifconfig  eth0 | head -n2 | grep inet | awk '{print$2}'`
           
          if ping -c 2 -W 3 www.baidu.com &> /dev/null ;then
          /home/ubuntu/mail.py striketong@163.com "Got raspberryPi IP!" "WLAN0:$wlan0||ETH0:$eth0"
          fi
          ```

      11.  重啟測試`sudo reboot`，看是否能自動連上Tsinghua-Secure

      12. 開機自動連接成功。

#### 3. 修改SSH port

由於校園網禁止22端口，所以需要修改預設端口。改成你想要的端口。0-1024，8000-8100，3389，9100這些都不能用。

1. `sudo vim /etc/ssh/ssh_config`、`sudo vim /etc/ssh/sshd_config`，找到`#Port 22`，改成`Port 8122`。

2. 設置防火牆

   ```
   sudo ufw allow 8122
   ```

3. 重啟SSH服務`sudo service sshd restart`

4. 嘗試利用SSH連接`ssh -p 8122 ubuntu@ip`，成功。


### U740

#### 1. 連接樹莓派與U740

1. 利用杜邦線物理連接樹莓派與U740

   1. 把原本版子上的`POWER SW`線換成自己的杜邦線。

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328150633057.png" alt="image-20220328150633057" style="zoom: 25%;" />

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328150655239.png" alt="image-20220328150655239" style="zoom: 25%;" />

   2. 把繼電器全部切換成高電平觸發

      <img src="C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328151918376.png" alt="image-20220328151918376" style="zoom:25%;" />

   3. 將杜邦線連接到繼電器上。（切記不要弄反，紫色接到NO1，白色接到COM1）

   4. 將樹莓派上的5V，GND以及訊號線(GPIO)接到繼電哭上的DC+，DC-，IN1上。接好後應如下圖所示。

      可以利用`pinout`來查看樹莓派上的對應接口。這裏接GPIO14。

      ![image-20220328152209310](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328152209310.png)

      ![image-20220328151624825](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20220328151624825.png)

      ![WeChat 圖片_20220328152306](C:\Users\user\Desktop\WeChat 圖片_20220328152306.jpg)

   5. 接上U740電源，進行下一步調試。

2. 在樹莓派上安裝python GPIO庫，`sudo apt-get install python3-dev python3-rpi.gpio`，撰寫GPIO測試程序`power.py`。

   - 1秒是開機，4秒是強制關機。

   ```
   import gpiod
   import time
   
   def button(secs, line):
       with gpiod.Chip("gpiochip0") as chip:
           line = chip.get_line(line)
           line.request(consumer="powerd", type=gpiod.LINE_REQ_DIR_OUT)
           line.set_value(1)
           time.sleep(secs)
           line.set_value(0)
           
   if __name__ == '__main__':
   	button(1, 14)
   ```

   運行語句`sudo python3 power.py`，運行後應該可以聽到十分清脆的繼電器啟動一下的聲音以及十分響亮的風扇聲。這便說明成功利用樹莓派控制板子啟動了。

#### 2. 建立遠程響應網站

為了避免每次登入樹莓派才能啟動U740，在此利用http請求實現一個更簡單的開機關機的方法。

1. 安裝Flask，`sudo apt-get install -y python3-flask`

2. 編輯`power.py`，利用Flask建立簡易網站用以接收開關機操作請求。

   ```
   from flask import Flask
   import RPi.GPIO as GPIO
   import gpiod
   import time
   
   def button(secs, line):
       with gpiod.Chip("gpiochip0") as chip:
           line = chip.get_line(line)
           line.request(consumer="powerd", type=gpiod.LINE_REQ_DIR_OUT)
           line.set_value(1)
           time.sleep(secs)
           line.set_value(0)
   
   app = Flask(__name__)
   
   @app.route("/")
   def hello_world():
       return "<p>Hello, World!</p>"
   
   @app.route("/poweron1")
   def poweron1():
       button(1, 14)
       return "<p>Power on machine-1!</p>"
   
   @app.route("/poweroff1")
   def poweroff1():
       button(4, 14)
       return "<p>Power off machine-1!</p>"""
   
   @app.route("/reboot1")
   def reboot1():
       button(4, 14)
       time.sleep(1)
       button(1, 14)
       return "Rebooted machine-1!"
   
   @app.route("/poweron2")
   def poweron2():
       button(1, 15)
       return "<p>Power on machine-2!</p>"
   
   @app.route("/poweroff2")
   def poweroff2():
       button(4, 15)
       return "<p>Power off machine-2!</p>"""
   
   @app.route("/reboot2")
   def reboot2():
       button(4, 15)
       time.sleep(1)
       button(1, 15)
       return "Rebooted machine-2!"
   
   if __name__ == '__main__':
       button(0, 14)
       button(0, 15)
       app.run(host='0.0.0.0', port=8182)
   
   ```

3. 運行程序`sudo python3 power.py`，之後便可以通過`http://IP:8182/operation`進行開關機操作。

#### 3. 配置usbip

U740裏有內建的UART/JTAG to USB利用usbip，可以遠程訪問USB，繼而訪問串口。

1. 

#### 4. 

 
